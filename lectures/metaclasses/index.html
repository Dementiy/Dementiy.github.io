


<!doctype html>
<html lang="ru" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Лекции и практические задания по программированию на Python">
      
      
        <link rel="canonical" href="https://dementiy.github.io/lectures/metaclasses/">
      
      
        <meta name="author" content="Sorokin Dmitrii">
      
      <link rel="shortcut icon" href="../../images/kitano.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Metaclasses - Программирование на Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.63b94e9e.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7f672a1f.min.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-111461883-1","dementiy.github.io"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://dementiy.github.io/" title="Программирование на Python" class="md-header-nav__button md-logo" aria-label="Программирование на Python">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Программирование на Python
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Metaclasses
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Поиск" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/Dementiy/pybook-assignments/" title="Перейти к репозиторию" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Dementiy/pybook-assignments
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../immutable-types/" class="md-tabs__link">
          Лекции
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../assignments/setup_env/" class="md-tabs__link">
          Практические работы
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../notes/cross-entropy/" class="md-tabs__link">
          Заметки
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://dementiy.github.io/" title="Программирование на Python" class="md-nav__button md-logo" aria-label="Программирование на Python">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Программирование на Python
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Dementiy/pybook-assignments/" title="Перейти к репозиторию" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Dementiy/pybook-assignments
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Лекции
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Лекции" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Лекции
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../immutable-types/" title="Неизменяемые типы данных" class="md-nav__link">
      Неизменяемые типы данных
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mutable-types/" title="Изменяемые типы данных" class="md-nav__link">
      Изменяемые типы данных
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../control-statements/" title="Управляющие конструкции" class="md-nav__link">
      Управляющие конструкции
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../functions/" title="Функции" class="md-nav__link">
      Функции
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ns_and_scopes/" title="Пространство имен и области видимости" class="md-nav__link">
      Пространство имен и области видимости
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../classes/" title="ООП. Классы. Магические методы" class="md-nav__link">
      ООП. Классы. Магические методы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../descriptors/" title="ООП. Дескрипторы" class="md-nav__link">
      ООП. Дескрипторы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../attribute_lookup/" title="ООП. Разрешение имен атрибтутов" class="md-nav__link">
      ООП. Разрешение имен атрибтутов
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mro/" title="ООП. Порядок разрешения методов" class="md-nav__link">
      ООП. Порядок разрешения методов
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../iterators/" title="Итераторы" class="md-nav__link">
      Итераторы
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Практические работы
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Практические работы" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Практические работы
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Basics
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Basics" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Basics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/setup_env/" title="Настройка рабочего окружения" class="md-nav__link">
      Настройка рабочего окружения
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/cypher/" title="Алгоритмы шифрования" class="md-nav__link">
      Алгоритмы шифрования
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/sudoku/" title="Решатель Судоку" class="md-nav__link">
      Решатель Судоку
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/life/" title="Игра «Жизнь»" class="md-nav__link">
      Игра «Жизнь»
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/pyvcs/" title="PyVCS. Распределенная система контроля версий" class="md-nav__link">
      PyVCS. Распределенная система контроля версий
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/vk_api/" title="Работа с API ВКонтакте" class="md-nav__link">
      Работа с API ВКонтакте
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/hackernews/" title="Персонализация новостной ленты Hacker News" class="md-nav__link">
      Персонализация новостной ленты Hacker News
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      DataScience
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="DataScience" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        DataScience
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/descriptive-statistics/" title="Описательная статистика с Pandas, SQL и R" class="md-nav__link">
      Описательная статистика с Pandas, SQL и R
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Заметки
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Заметки" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Заметки
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/cross-entropy/" title="Энтропия и кросс-энтропия" class="md-nav__link">
      Энтропия и кросс-энтропия
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Metaclasses</h1>
                
                <p>В лекции «ООП: Классы» мы говорили о том, что классы контролируют создание новых экземпляров, но, как мы помним, в Python все является объектом, в том числе и классы, поэтому есть классы, которые контролируют создание новых классов - метаклассы (метатипы).</p>
<p>По умолчанию метаклассом для всех классов является класс <code>type</code>, только если явно не был указан другой метакласс:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AbstractUser</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
  <span class="nd">@abc.abstractmethod</span>
  <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>

  <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">__main__</span><span class="o">.</span><span class="n">User</span><span class="s1">&#39;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="s1">&#39;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">type</span><span class="s1">&#39;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
<span class="bp">True</span>
</code></pre></div>

<p><img alt="image" class="center" src="../../images/lectures/metaclasses/instance_of.svg" /></p>
<p>Также вспомним, что все типы в виртуальной машине CPython представлены структурой <a href="https://docs.python.org/3/c-api/typeobj.html"><code>PyTypeObject</code></a>, которая в основном содержит указатели на функции-слоты, которые определяют поведение объекта:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// https://github.com/python/cpython/blob/master/Include/cpython/object.h#L189</span>
<span class="k">struct</span> <span class="n">_typeobject</span> <span class="p">{</span>
    <span class="n">PyObject_VAR_HEAD</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tp_name</span><span class="p">;</span> <span class="cm">/* For printing, in format &quot;&lt;module&gt;.&lt;name&gt;&quot; */</span>
    <span class="n">Py_ssize_t</span> <span class="n">tp_basicsize</span><span class="p">,</span> <span class="n">tp_itemsize</span><span class="p">;</span> <span class="cm">/* For allocation */</span>

    <span class="c1">// ...</span>

    <span class="cm">/* Method suites for standard classes */</span>

    <span class="n">PyNumberMethods</span> <span class="o">*</span><span class="n">tp_as_number</span><span class="p">;</span>
    <span class="n">PySequenceMethods</span> <span class="o">*</span><span class="n">tp_as_sequence</span><span class="p">;</span>
    <span class="n">PyMappingMethods</span> <span class="o">*</span><span class="n">tp_as_mapping</span><span class="p">;</span>

    <span class="c1">// ...</span>
    <span class="n">ternaryfunc</span> <span class="n">tp_call</span><span class="p">;</span>
    <span class="c1">// ...</span>
    <span class="n">initproc</span> <span class="n">tp_init</span><span class="p">;</span>
    <span class="c1">// ...</span>
    <span class="n">newfunc</span> <span class="n">tp_new</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>Например, тип может поддерживать численный протокол (numeric protocol), для этого слот <code>tp_as_number</code> должен содержать указатель на структуру <a href="https://docs.python.org/3/c-api/typeobj.html#number-structs">PyNumberMethods</a>, с реализацией соответствующих методов (когда слоты объединены в единую структуру, то их называют подслотами). Рассмотрим пример для целых чисел:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">PyNumberMethods</span> <span class="n">long_as_number</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">binaryfunc</span><span class="p">)</span><span class="n">long_add</span><span class="p">,</span>       <span class="cm">/*nb_add*/</span>
    <span class="p">(</span><span class="n">binaryfunc</span><span class="p">)</span><span class="n">long_sub</span><span class="p">,</span>       <span class="cm">/*nb_subtract*/</span>
    <span class="p">(</span><span class="n">binaryfunc</span><span class="p">)</span><span class="n">long_mul</span><span class="p">,</span>       <span class="cm">/*nb_multiply*/</span>
    <span class="c1">// ...</span>
<span class="p">};</span>

<span class="n">PyTypeObject</span> <span class="n">PyLong_Type</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyType_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s">&quot;int&quot;</span><span class="p">,</span>                                      <span class="cm">/* tp_name */</span>
    <span class="c1">// ...</span>
    <span class="o">&amp;</span><span class="n">long_as_number</span><span class="p">,</span>                            <span class="cm">/* tp_as_number */</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>Для сложения двух объектов используется инструкция <code>BINARY_ADD</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;a + b&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_NAME</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">BINARY_ADD</span>
              <span class="mi">6</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Давайте посмотрим на описание этой инструкции:</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span> <span class="nf">TARGET</span><span class="p">(</span><span class="n">BINARY_ADD</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="n">TOP</span><span class="p">();</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sum</span><span class="p">;</span>
    <span class="cm">/* NOTE(vstinner): Please don&#39;t try to micro-optimize int+int on</span>
<span class="cm">        CPython using bytecode, it is simply worthless.</span>
<span class="cm">        See http://bugs.python.org/issue21955 and</span>
<span class="cm">        http://bugs.python.org/issue10044 for the discussion. In short,</span>
<span class="cm">        no patch shown any impact on a realistic benchmark, only a minor</span>
<span class="cm">        speedup on microbenchmarks. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyUnicode_CheckExact</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="n">PyUnicode_CheckExact</span><span class="p">(</span><span class="n">right</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">unicode_concatenate</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">next_instr</span><span class="p">);</span>
        <span class="cm">/* unicode_concatenate consumed the ref to left */</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">PyNumber_Add</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
    <span class="n">SET_TOP</span><span class="p">(</span><span class="n">sum</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="n">DISPATCH</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>В случае строк будет выполнена конкатенация, во всех остальных случаях будет вызвана функция <code>PyNumber_Add</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyNumber_Add</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">BINARY_OP1</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">NB_SLOT</span><span class="p">(</span><span class="n">nb_add</span><span class="p">),</span> <span class="s">&quot;+&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">Py_NotImplemented</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

    <span class="n">PySequenceMethods</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_as_sequence</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">sq_concat</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sq_concat</span><span class="p">)(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">_Py_CheckSlotResult</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="n">result</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">binop_type_error</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="s">&quot;+&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Наконец:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">binary_op1</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">op_slot</span>
<span class="cp">#ifndef NDEBUG</span>
           <span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">op_name</span>
<span class="cp">#endif</span>
           <span class="p">)</span>
<span class="p">{</span>
    <span class="n">binaryfunc</span> <span class="n">slotv</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_as_number</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">slotv</span> <span class="o">=</span> <span class="n">NB_BINOP</span><span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_as_number</span><span class="p">,</span> <span class="n">op_slot</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">slotv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">binaryfunc</span> <span class="n">slotw</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Py_IS_TYPE</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_as_number</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">slotw</span> <span class="o">=</span> <span class="n">NB_BINOP</span><span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_as_number</span><span class="p">,</span> <span class="n">op_slot</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slotw</span> <span class="o">==</span> <span class="n">slotv</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">slotw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">slotw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">slotv</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slotw</span> <span class="o">&amp;&amp;</span> <span class="n">PyType_IsSubtype</span><span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">slotw</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">Py_NotImplemented</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="cm">/* can&#39;t do it */</span>
            <span class="n">slotw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">slotv</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">_Py_CheckSlotResult</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">Py_NotImplemented</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="cm">/* can&#39;t do it */</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slotw</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">slotw</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">_Py_CheckSlotResult</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">Py_NotImplemented</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="cm">/* can&#39;t do it */</span>
    <span class="p">}</span>
    <span class="n">Py_RETURN_NOTIMPLEMENTED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Функция <code>binary_op1</code> принимает три аргумента: левый операнд, правый операнд и смещение слота. Далее проверяется реализуют ли левый и правый операнды (при условии, что его тип отличен от типа левого операнда) требуюмую операциию. Затем логика простая:</p>
<ul>
<li>если левый операнд не содержит слота, то вызвать слот правого;</li>
<li>если правый операнд является подтипом левого, то вызвать его реализацию;</li>
<li>иначе вызвать слот левого операнда.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># https://tenthousandmeters.com/blog/python-behind-the-scenes-6-how-python-object-system-works/</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">HungryInt</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="bp">self</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">HungryInt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>
<span class="mi">5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">x</span>
<span class="mi">7</span>
</code></pre></div>

<p>Важно не путать объекты, содержащие данные, и типы:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="bp">True</span>
</code></pre></div>

<p>В примере объекты <code>1</code> и <code>2</code> различны, но у них один тип <code>int</code>, в свою очередь типом которого является <code>type</code>, а типом <code>type</code> является... тоже <code>type</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">type</span><span class="s1">&#39;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
<span class="bp">True</span>
</code></pre></div>

<p>Если мы посмотрим на определение структуры <code>PyType_Type</code>, то заметим, что <code>type</code> в качестве типа содержит ссылку на себя самого:</p>
<div class="highlight"><pre><span></span><code><span class="n">PyTypeObject</span> <span class="n">PyType_Type</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyType_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s">&quot;type&quot;</span><span class="p">,</span>                                     <span class="cm">/* tp_name */</span>
    <span class="c1">// ...</span>
    <span class="n">offsetof</span><span class="p">(</span><span class="n">PyTypeObject</span><span class="p">,</span> <span class="n">tp_vectorcall</span><span class="p">),</span>      <span class="cm">/* tp_vectorcall_offset */</span>
    <span class="c1">// ...</span>
    <span class="p">(</span><span class="n">ternaryfunc</span><span class="p">)</span><span class="n">type_call</span><span class="p">,</span>                     <span class="cm">/* tp_call */</span>
    <span class="c1">// ...</span>
    <span class="n">offsetof</span><span class="p">(</span><span class="n">PyTypeObject</span><span class="p">,</span> <span class="n">tp_dict</span><span class="p">),</span>            <span class="cm">/* tp_dictoffset */</span>
    <span class="n">type_init</span><span class="p">,</span>                                  <span class="cm">/* tp_init */</span>
    <span class="mi">0</span><span class="p">,</span>                                          <span class="cm">/* tp_alloc */</span>
    <span class="n">type_new</span><span class="p">,</span>                                   <span class="cm">/* tp_new */</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p><img alt="image" class="center" src="../../images/lectures/metaclasses/instance_of_type.svg" /></p>
<p>Давайте сначала рассмотрим в общих чертах как происходит определение нового класса на примере класса пользователь определенного выше.</p>
<p>Если не был явно указан метакласс, то берется метакласс наиболее подходящего родителя:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">meta</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">meta</span>
<span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>
</code></pre></div>

<p>Затем мы «изолируем» тело класса:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">cls_body</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">NUM_EYES = 2</span>

<span class="s2">def __init__(self, username: str) -&gt; None:</span>
<span class="s2">    self.username = username</span>

<span class="s2">def is_anonymous(self) -&gt; bool:</span>
<span class="s2">  return False</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>

<p>На следующем шаге будет создан (подготовлен) словарь атрибутов класса:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">cls_dict</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">__prepare__</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">AbstractUser</span><span class="p">,))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cls_dict</span>
<span class="p">{}</span>
</code></pre></div>

<p>На третьем шаге выполняется тело класса в окружении глобального и локального (словаря атрибутов) пространства имен:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">exec</span><span class="p">(</span><span class="n">cls_body</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="n">cls_dict</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cls_dict</span>
<span class="p">{</span>
  <span class="s1">&#39;__init__&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="fm">__init__</span> <span class="n">at</span> <span class="mh">0x10d6c2d30</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="s1">&#39;is_anonymous&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">is_anonymous</span> <span class="n">at</span> <span class="mh">0x10d6c2700</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre></div>

<p>Как видно, результатом выполнения этого шага является заполнение словаря атрибутов класса. Затем создается сам класс:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">AbstractUser</span><span class="p">,),</span> <span class="n">cls_dict</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;bob&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bob</span><span class="o">.</span><span class="n">username</span>
<span class="s1">&#39;bob&#39;</span>
</code></pre></div>

<p>И наконец, если для класса в метаклассе был определен инициализатор, то он будет вызван:</p>
<div class="highlight"><pre><span></span><code><span class="n">meta</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">AbstractUser</span><span class="p">,),</span> <span class="n">cls_dict</span><span class="p">)</span>
</code></pre></div>

<p>Последние шаги должны вам напоминать создание экземпляра класса, дальше мы увидим, что они и правда очень похожи.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">__prepare__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;__prepare__ was called on {meta.__name__} with {name}, {bases}&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__prepare__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;__new__ was called on {meta.__name__} with {name}, {bases}, {kwds}&quot;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;__init__ was called on {cls.__name__} with {name}, {bases}, {kwds}&quot;</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;__init__&quot;</span><span class="p">:</span> <span class="fm">__init__</span><span class="p">,</span> <span class="s2">&quot;get_username&quot;</span><span class="p">:</span> <span class="n">get_username</span><span class="p">})</span>
<span class="fm">__new__</span> <span class="n">was</span> <span class="n">called</span> <span class="n">on</span> <span class="n">Meta</span> <span class="k">with</span> <span class="n">User</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;__init__&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="fm">__init__</span> <span class="n">at</span> <span class="mh">0x1039693a0</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;get_username&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">get_username</span> <span class="n">at</span> <span class="mh">0x103969430</span><span class="o">&gt;</span><span class="p">}</span>
<span class="fm">__init__</span> <span class="n">was</span> <span class="n">called</span> <span class="n">on</span> <span class="n">User</span> <span class="k">with</span> <span class="n">User</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;__init__&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="fm">__init__</span> <span class="n">at</span> <span class="mh">0x1039693a0</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;get_username&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">get_username</span> <span class="n">at</span> <span class="mh">0x103969430</span><span class="o">&gt;</span><span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
<span class="o">...</span>         <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">get_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
<span class="o">...</span>
<span class="n">__prepare__</span> <span class="n">was</span> <span class="n">called</span> <span class="n">on</span> <span class="n">Meta</span> <span class="k">with</span> <span class="n">User</span><span class="p">,</span> <span class="p">()</span>
<span class="fm">__new__</span> <span class="n">was</span> <span class="n">called</span> <span class="n">on</span> <span class="n">Meta</span> <span class="k">with</span> <span class="n">User</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;__module__&#39;</span><span class="p">:</span> <span class="s1">&#39;__main__&#39;</span><span class="p">,</span> <span class="s1">&#39;__qualname__&#39;</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="s1">&#39;__init__&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">User</span><span class="o">.</span><span class="fm">__init__</span> <span class="n">at</span> <span class="mh">0x103969e50</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;get_username&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">User</span><span class="o">.</span><span class="n">get_username</span> <span class="n">at</span> <span class="mh">0x103969ee0</span><span class="o">&gt;</span><span class="p">}</span>
<span class="fm">__init__</span> <span class="n">was</span> <span class="n">called</span> <span class="n">on</span> <span class="n">User</span> <span class="k">with</span> <span class="n">User</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;__module__&#39;</span><span class="p">:</span> <span class="s1">&#39;__main__&#39;</span><span class="p">,</span> <span class="s1">&#39;__qualname__&#39;</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="s1">&#39;__init__&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">User</span><span class="o">.</span><span class="fm">__init__</span> <span class="n">at</span> <span class="mh">0x103969e50</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;get_username&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">User</span><span class="o">.</span><span class="n">get_username</span> <span class="n">at</span> <span class="mh">0x103969ee0</span><span class="o">&gt;</span><span class="p">}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># https://github.com/fastai/fastcore/blob/master/fastcore/meta.py#L24</span>
<span class="k">class</span> <span class="nc">PrePostInit</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__pre_init__&quot;</span><span class="p">):</span>
      <span class="n">obj</span><span class="o">.</span><span class="n">__pre_init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__post_init__&quot;</span><span class="p">):</span>
      <span class="n">obj</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>
</code></pre></div>

<p>Давайте теперь рассмотрим как происходит создание нового класса:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... class User(AbstractUser):</span>
<span class="s2">...     @property</span>
<span class="s2">...     def is_anonymous(self) -&gt; bool:</span>
<span class="s2">...         return False</span>
<span class="s2">... &quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_BUILD_CLASS</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">User</span> <span class="n">at</span> <span class="mh">0x100df9660</span><span class="p">,</span> <span class="nb">file</span> <span class="s2">&quot;&lt;dis&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">MAKE_FUNCTION</span>            <span class="mi">0</span>
              <span class="mi">8</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
             <span class="mi">10</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">AbstractUser</span><span class="p">)</span>
             <span class="mi">12</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">3</span>
             <span class="mi">14</span> <span class="n">STORE_NAME</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span>
             <span class="mi">16</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
             <span class="mi">18</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Инструкция <code>LOAD_BUILD_CLASS</code> помещает на стек встроенную функцию <code>__build_class__</code>, <code>LOAD_CONST</code> помещает на стек объект кода, имя класса и создает функцию:</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span> <span class="nf">TARGET</span><span class="p">(</span><span class="n">MAKE_FUNCTION</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">qualname</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">codeobj</span> <span class="o">=</span> <span class="n">POP</span><span class="p">();</span>
    <span class="n">PyFunctionObject</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyFunctionObject</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">PyFunction_NewWithQualName</span><span class="p">(</span><span class="n">codeobj</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">f_globals</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
    <span class="c1">// ...</span>
    <span class="n">PUSH</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">func</span><span class="p">);</span>
    <span class="n">DISPATCH</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>...</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">__builtins__</span><span class="o">.</span><span class="n">__build_class__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">A</span><span class="p">:</span> <span class="k">pass</span>
<span class="o">...</span> 
<span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">A</span> <span class="n">at</span> <span class="mh">0x104fadaf0</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;class User: pass&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_BUILD_CLASS</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">User</span> <span class="n">at</span> <span class="mh">0x10b771390</span> <span class="o">...&gt;</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">MAKE_FUNCTION</span>            <span class="mi">0</span>
              <span class="mi">8</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
             <span class="mi">10</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">2</span>
             <span class="mi">12</span> <span class="n">STORE_NAME</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span>
             <span class="mi">14</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
             <span class="mi">16</span> <span class="n">RETURN_VALUE</span>

<span class="n">Disassembly</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">User</span> <span class="n">at</span> <span class="mh">0x10b771390</span> <span class="o">...&gt;</span><span class="p">:</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">STORE_NAME</span>               <span class="mi">1</span> <span class="p">(</span><span class="vm">__module__</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">STORE_NAME</span>               <span class="mi">2</span> <span class="p">(</span><span class="n">__qualname__</span><span class="p">)</span>
              <span class="mi">8</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
             <span class="mi">10</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>...</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span> <span class="nf">TARGET</span><span class="p">(</span><span class="n">LOAD_BUILD_CLASS</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">_Py_IDENTIFIER</span><span class="p">(</span><span class="n">__build_class__</span><span class="p">);</span>

    <span class="n">PyObject</span> <span class="o">*</span><span class="n">bc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_CheckExact</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_builtins</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">_PyDict_GetItemIdWithError</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f_builtins</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PyId___build_class__</span><span class="p">);</span>
        <span class="c1">// ...</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
    <span class="n">PUSH</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
    <span class="n">DISPATCH</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p><code>CALL_FUNCTION</code> вызывает <code>___build_class__</code> для создания класса (Python/bltinmodule.c:105).</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* AC: cannot convert yet, waiting for *args support */</span>
<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">builtin___build_class__</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">nargs</span><span class="p">,</span>
                        <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">bases</span><span class="p">,</span> <span class="o">*</span><span class="n">mkw</span><span class="p">,</span> <span class="o">*</span><span class="n">meta</span><span class="p">,</span> <span class="o">*</span><span class="n">winner</span><span class="p">,</span> <span class="o">*</span><span class="n">prep</span><span class="p">,</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="o">*</span><span class="n">orig_bases</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">cls</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">isclass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* initialize to prevent gcc warning */</span>

    <span class="c1">// ...</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>   <span class="cm">/* Better be callable */</span>
    <span class="c1">// ...</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="c1">// ...</span>
    <span class="n">orig_bases</span> <span class="o">=</span> <span class="n">_PyTuple_FromArray</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nargs</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">orig_bases</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">bases</span> <span class="o">=</span> <span class="n">update_bases</span><span class="p">(</span><span class="n">orig_bases</span><span class="p">,</span> <span class="n">args</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nargs</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
    <span class="c1">// ...</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">meta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* if there are no bases, use type: */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">PyType_Type</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* else get the type of the first base */</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">PyObject</span> <span class="o">*</span><span class="n">base0</span> <span class="o">=</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">base0</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
        <span class="n">isclass</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* meta is really a class */</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
    <span class="cm">/* else: meta is not a class, so we cannot do the metaclass</span>
<span class="cm">       calculation, so we will use the explicitly given object as it is */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_PyObject_LookupAttrId</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PyId___prepare__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">PyDict_New</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">pargs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">};</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">_PyObject_FastCallDict</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">pargs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mkw</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">prep</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">PyEval_EvalCodeEx</span><span class="p">(</span><span class="n">PyFunction_GET_CODE</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">PyFunction_GET_GLOBALS</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">ns</span><span class="p">,</span>
                             <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                             <span class="n">PyFunction_GET_CLOSURE</span><span class="p">(</span><span class="n">func</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cell</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">margs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">ns</span><span class="p">};</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">_PyObject_FastCallDict</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">margs</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mkw</span><span class="p">);</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="n">cls</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>(gdb) p ((PyTypeObject*)((PyTupleObject*)bases)-&gt;ob_item[0])-&gt;tp_name</p>
<p>$36 = 0x100ebeca0 "A"</p>
<ol>
<li>Первый The first chunk of code deals with extracting the arguments and setting defaults.</li>
<li>Next, if no metaclass is supplied, BBC looks at the base classes and takes the metaclass of the first base class. If there are no base  classes, the default metaclass <code>type</code> is used.</li>
<li>If the metaclass is really a class (note that in Python any callable can be given as a metaclass), look at the bases again to determine "the most derived" metaclass.</li>
<li>At this point BBC has a metaclass [<a href="https://eli.thegreenplace.net/2012/06/15/under-the-hood-of-python-class-definitions#id15">5]</a>, so it starts by calling its <code>__prepare__</code> method to create a namespace dictionary for the class. If there's no such method, an empty dict is used</li>
<li>The function argument is invoked, passing the namespace dict as the only argument. If we look back at the disassembly of this function (the  second one), we see that the first argument is placed into the <code>f_locals</code> attribute of the frame (with the <code>STORE_LOCALS</code> instruction). In other words, this dictionary is then used to populate the class attributes. The function itself returns <code>None</code> - its outcome is modifying the namespace dictionary.</li>
<li>Finally, the metaclass is called with the name, list of bases and namespace dictionary as arguments.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="p">((</span><span class="n">PyFunctionObject</span> <span class="o">*</span><span class="p">)</span><span class="n">func</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">func_name</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">AbstractUser</span><span class="err">&#39;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">name</span>
<span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">AbstractUser</span><span class="err">&#39;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">bases</span>
<span class="err">$</span><span class="mi">3</span> <span class="o">=</span> <span class="p">()</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">ns</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">__module__</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">__qualname__</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">AbstractUser</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">is_anonymous</span><span class="err">&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">at</span> <span class="n">remote</span> <span class="mh">0x100fb741</span>
<span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="p">((</span><span class="n">PyTypeObject</span><span class="o">*</span><span class="p">)</span><span class="n">meta</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_name</span> 
<span class="err">$</span><span class="mi">5</span> <span class="o">=</span> <span class="mh">0x1003ddd46</span> <span class="s">&quot;type&quot;</span>
</code></pre></div>

<p><strong>type_call -&gt; Objects/typeobject.c:1000</strong></p>
<p><img alt="image" class="center" src="../../images/lectures/metaclasses/class_creation.svg" /></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">wrapt</span>


<span class="nd">@wrapt.decorator</span>
<span class="k">def</span> <span class="nf">log_call</span><span class="p">(</span><span class="n">wrapped_method</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Print when the decorated method is called. &quot;&quot;&quot;</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">wrapped_method</span><span class="o">.</span><span class="n">__qualname__</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__qualname__</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Calling method {method_name} for {class_name}.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapped_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LogMethods</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Metaclass that decorates methods with log_call. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Последнее обновление: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">4 апреля 2021 г.</span>
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Комментарии</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="https://dementiy.github.io/lectures/metaclasses/",this.page.identifier="lectures/metaclasses/"};!function(){var e=document,i=e.createElement("script");i.src="//Dementiy.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)}()</script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 - 2020 <a href="https://github.com/Dementiy" target="_blank" rel="noopener">Dmitrii Sorokin</a>

          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/Dementiy" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432 \u0431\u0443\u0444\u0435\u0440", "clipboard.copied": "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440", "search.config.lang": "ru", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "\u041d\u0430\u0447\u043d\u0438\u0442\u0435 \u043f\u0435\u0447\u0430\u0442\u0430\u0442\u044c \u0434\u043b\u044f \u043f\u043e\u0438\u0441\u043a\u0430", "search.result.none": "\u0421\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e", "search.result.one": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e 1 \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0435", "search.result.other": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e # \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs", "instant"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>