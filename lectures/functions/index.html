


<!doctype html>
<html lang="ru" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Лекции и практические задания по программированию на Python">
      
      
        <link rel="canonical" href="https://dementiy.github.io/lectures/functions/">
      
      
        <meta name="author" content="Sorokin Dmitrii">
      
      <link rel="shortcut icon" href="../../images/kitano.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Функции - Программирование на Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.63b94e9e.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.7f672a1f.min.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-111461883-1","dementiy.github.io"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Перейти к содержанию
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://dementiy.github.io/" title="Программирование на Python" class="md-header-nav__button md-logo" aria-label="Программирование на Python">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Программирование на Python
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Функции
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Поиск" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/Dementiy/pybook-assignments/" title="Перейти к репозиторию" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Dementiy/pybook-assignments
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../immutable-types/" class="md-tabs__link md-tabs__link--active">
          Лекции
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../assignments/setup_env/" class="md-tabs__link">
          Практические работы
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../notes/cross-entropy/" class="md-tabs__link">
          Заметки
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://dementiy.github.io/" title="Программирование на Python" class="md-nav__button md-logo" aria-label="Программирование на Python">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Программирование на Python
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Dementiy/pybook-assignments/" title="Перейти к репозиторию" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Dementiy/pybook-assignments
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" checked>
    
    <label class="md-nav__link" for="nav-1">
      Лекции
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Лекции" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Лекции
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../immutable-types/" title="Неизменяемые типы данных" class="md-nav__link">
      Неизменяемые типы данных
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mutable-types/" title="Изменяемые типы данных" class="md-nav__link">
      Изменяемые типы данных
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../control-statements/" title="Управляющие конструкции" class="md-nav__link">
      Управляющие конструкции
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Функции
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Функции" class="md-nav__link md-nav__link--active">
      Функции
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Содержание">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Содержание
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    Пример поиска минимального элемента
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    Как создаются функции
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    Атрибуты функций
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    Вызов функций
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    Декораторы
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ns_and_scopes/" title="Пространство имен и области видимости" class="md-nav__link">
      Пространство имен и области видимости
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../classes/" title="ООП. Классы. Магические методы" class="md-nav__link">
      ООП. Классы. Магические методы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../descriptors/" title="ООП. Дескрипторы" class="md-nav__link">
      ООП. Дескрипторы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../attribute_lookup/" title="ООП. Разрешение имен атрибтутов" class="md-nav__link">
      ООП. Разрешение имен атрибтутов
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mro/" title="ООП. Порядок разрешения методов" class="md-nav__link">
      ООП. Порядок разрешения методов
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../iterators/" title="Итераторы" class="md-nav__link">
      Итераторы
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Практические работы
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Практические работы" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Практические работы
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Basics
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Basics" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Basics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/setup_env/" title="Настройка рабочего окружения" class="md-nav__link">
      Настройка рабочего окружения
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/cypher/" title="Алгоритмы шифрования" class="md-nav__link">
      Алгоритмы шифрования
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/sudoku/" title="Решатель Судоку" class="md-nav__link">
      Решатель Судоку
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/life/" title="Игра «Жизнь»" class="md-nav__link">
      Игра «Жизнь»
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/pyvcs/" title="PyVCS. Распределенная система контроля версий" class="md-nav__link">
      PyVCS. Распределенная система контроля версий
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/vk_api/" title="Работа с API ВКонтакте" class="md-nav__link">
      Работа с API ВКонтакте
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/hackernews/" title="Персонализация новостной ленты Hacker News" class="md-nav__link">
      Персонализация новостной ленты Hacker News
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      DataScience
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="DataScience" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        DataScience
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/descriptive-statistics/" title="Описательная статистика с Pandas, SQL и R" class="md-nav__link">
      Описательная статистика с Pandas, SQL и R
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Заметки
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Заметки" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Заметки
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/cross-entropy/" title="Энтропия и кросс-энтропия" class="md-nav__link">
      Энтропия и кросс-энтропия
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notes/regression/" title="Линейная регрессия" class="md-nav__link">
      Линейная регрессия
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Содержание">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Содержание
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    Пример поиска минимального элемента
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    Как создаются функции
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    Атрибуты функций
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    Вызов функций
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    Декораторы
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Функции</h1>
                
                <p>Когда речь заходит о функциях, то вспоминают математичекое определение:</p>
<blockquote>
<p><strong>Функция</strong> это соответствие между двумя множествами, такое, что каждому элементу первого множества соответствует один и только один элемент второго множества.</p>
</blockquote>
<p>В программировании под функцией обычно понимают именованый блок кода (хотя функции могут быть и анонимными), который выполняет некоторую задачу и может быть переиспользован множество раз. К математическому описанию функции близки, так называемые, чистые функции, то есть, функции с детерминированным поведением и без побочных эффектов.</p>
<h2 id="_1">Пример поиска минимального элемента</h2>
<p>Давайте начнем с простого примера, напишем функцию возвращающую минимум от двух аргументов:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Function to get minimum of two arguments</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    The smallest argument.</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; my_min(0, 1)</span>
<span class="sd">    0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Аргументы или параметры</p>
<p><strong>Формальным</strong> параметром функции называется перменная, которая будет связана с переданным в функцию значением. <strong>Аргументом</strong> функции называется переменная (или выражение), значение которой используется при вызове функции:</p>
<div class="highlight"><pre><span></span><code>def my_min(a, b)
           ^  ^
           параметры функции

a, b = 1, 2
my_min(a, b)
       ^  ^
       аргументы функции
</code></pre></div>

<p>Обычно аргументы и параметры называют просто аргументами.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Докстроки</p>
<p>В тройных кавычках записывается строка документации (docstring), в которой описывается назначение функции (класса, модуля), список аргументов, возвращаемое значение, примеры использования функции и т.д. Примеры обычно записываются в виде документированных тестов (doctest), которые можно запустить с помощью модуля <code>doctest</code>. Есть различные соглашения по оформелнию строк документации, но единого правила нет. Существует несколько проектов предназначенных для автоматической генерации документации на основе докстрок, например, <a href="http://www.sphinx-doc.org/en/master/">Sphinx</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Аннотации функций</p>
<p>Аннотации типов (или подсказки типов) в основном предназначены для сообщения о том, какими типами обладают аргументы в функциях и методах. Есть несколько популярных «тайпчекеров», среди которых наиболее популярны <a href="http://mypy-lang.org/">mypy</a> и <a href="https://pyre-check.org/">pyre</a>. За информацией по аннотированию типов и функций можно обратиться к <a href="https://www.python.org/dev/peps/pep-3107/">PEP-3107</a> и <a href="https://www.python.org/dev/peps/pep-0484/">PEP-484</a>.</p>
</div>
<p>Список инструкций, которые будут выполнены при вызове функции, также достаточно простой, на стек помещаются два значения, выполняется операция сравнения и, в зависимости от результата, возвращается значение <code>a</code> или <code>b</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">my_min</span><span class="p">)</span>
 <span class="mi">13</span>           <span class="mi">0</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">COMPARE_OP</span>               <span class="mi">0</span> <span class="p">(</span><span class="o">&lt;</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">POP_JUMP_IF_FALSE</span>       <span class="mi">12</span>
              <span class="mi">8</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
             <span class="mi">10</span> <span class="n">RETURN_VALUE</span>
        <span class="o">&gt;&gt;</span>   <span class="mi">12</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
             <span class="mi">14</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>При вызове функции мы можем передать наши аргументы как позиционные, в таком случае важен порядок следования аргументов (хотя не для нашей функции <code>my_min</code>):</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;my_min(1, 2)&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">my_min</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">2</span>
              <span class="mi">8</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Также мы можем передать аргументы как именованные, в этом случае не имеет значения в каком порядке мы их указываем:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;my_min(b=1, a=2)&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">my_min</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">((</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">))</span>
              <span class="mi">8</span> <span class="n">CALL_FUNCTION_KW</span>         <span class="mi">2</span>
             <span class="mi">10</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>И, наконец, мы можем использовать смешанный вариант передачи аргументов:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;my_min(2, b=1)&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">my_min</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">((</span><span class="s1">&#39;b&#39;</span><span class="p">,))</span>
              <span class="mi">8</span> <span class="n">CALL_FUNCTION_KW</span>         <span class="mi">2</span>
             <span class="mi">10</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Вне зависимости от того как мы осуществляем вызов функции, все аргументы являются обязательными для передачи в функцию. Давайте немного усложним пример добавив еще один аргумент, таким образом, мы будем искать минимальное среди трех аргументов:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">elif</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">c</span>
</code></pre></div>

<p>Мы можем обобщить нашу функцию на список значений:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p>или на произвольное число позиционных аргументов с помощью оператора <code>*</code> (для переменного числа именованных аргументов используется <code>**</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p>Сейчас мы можем вызвать функцию <code>my_min</code> без аргументов (в таком случае результатом работы функции будет «плюс» бесконечность), если же мы хотим, чтобы в нее был передан хотя бы один обязательный аргумент, то мы должны это явно указать:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p>Давайте еще немного усложним нашу функцию, добавив нижнюю и верхнюю границы, которые задают диапазон для поиска минимального:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">),</span> <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Function to get the smallest number.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    x: float</span>
<span class="sd">        Required numeric value.</span>
<span class="sd">    values: float, optional</span>
<span class="sd">        Variable length argument list of numeric values.</span>
<span class="sd">    lower: float, optional</span>
<span class="sd">        Lower bound. The default lower bound is negative infinity.</span>
<span class="sd">    upper: float, optional</span>
<span class="sd">        Upper bound. The default upper bound is positive infinity.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    The smallest value.</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; my_min(-1, 0, 1, 2, 3)</span>
<span class="sd">    -1</span>
<span class="sd">    &gt;&gt;&gt; my_min(-1, 0, 1, 2, 3, lower=0)</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; my_min(-1, 0, 1, 2, 3, lower=4, upper=5)</span>
<span class="sd">    &gt;&gt;&gt; my_min(-1, 0, 1, 2, 3, lower=3, upper=-1)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    Exception: `lower` must be less or equal to `upper`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lower</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;`lower={lower}` must be less or equal to `upper={upper}`&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">upper</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p>Обратите внимание, что если у аргументов <code>lower</code> и <code>upper</code> не указать значения по умолчанию, то в Python 3, эти аргументы будут обязательными для передачи в функцию:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">my_min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
<span class="o">...</span>    <span class="c1"># ...</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="o">...</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">my_min</span><span class="p">()</span> <span class="n">missing</span> <span class="mi">2</span> <span class="n">required</span> <span class="n">keyword</span><span class="o">-</span><span class="n">only</span> <span class="n">arguments</span><span class="p">:</span> <span class="s1">&#39;lower&#39;</span> <span class="ow">and</span> <span class="s1">&#39;upper&#39;</span>
</code></pre></div>

<p>Мы можем обязать пользователя передавать только <a href="https://www.python.org/dev/peps/pep-3102/">именованные аргументы</a>, указав <code>*</code> перед списком аргументов (пример взят из <a href="https://treyhunner.com/2018/04/keyword-arguments-in-python/">статьи</a> Trey Hunner’а):</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span><span class="p">,</span> <span class="n">shuffle</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="k">def</span> <span class="nf">random_password</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">digits</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; random_password(upper=1, lower=1, digits=1, length=8)</span>
<span class="sd">    &#39;ooM2yCFc&#39;</span>
<span class="sd">    &gt;&gt;&gt; random_password(upper=1, lower=1, digits=1, length=8)</span>
<span class="sd">    &#39;HeCr68ct&#39;</span>
<span class="sd">    &gt;&gt;&gt; random_password(1, 1, 1, 8)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: random_password() takes 0 positional arguments but 4 were given</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">*</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">upper</span><span class="p">)),</span>
        <span class="o">*</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lower</span><span class="p">)),</span>
        <span class="o">*</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">digits</span><span class="p">)),</span>
        <span class="o">*</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="n">upper</span><span class="o">-</span><span class="n">lower</span><span class="o">-</span><span class="n">digits</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
</code></pre></div>

<h2 id="_2">Как создаются функции</h2>
<p>Давайте перечислим <a href="https://cpython-devguide.readthedocs.io/compiler/">шаги</a>, которые описывают как в CPython исходный код преобразуется в байткод:</p>
<ol>
<li>Код переводится в лексемы</li>
<li>Лексемы переводятся в AST (Abstract Syntax Tree, абстрактное синтаксическое деерво)</li>
<li>AST переводится в CFG (Control-flow Graph, граф потока управления)</li>
<li>CFG переводится в байткод.</li>
</ol>
<p>Байткод представлен специальными объектами кода (code objects):</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* Bytecode object */</span>
<span class="k">struct</span> <span class="n">PyCodeObject</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="kt">int</span> <span class="n">co_argcount</span><span class="p">;</span>            <span class="cm">/* #arguments, except *args */</span>
    <span class="kt">int</span> <span class="n">co_posonlyargcount</span><span class="p">;</span>     <span class="cm">/* #positional only arguments */</span>
    <span class="kt">int</span> <span class="n">co_kwonlyargcount</span><span class="p">;</span>      <span class="cm">/* #keyword only arguments */</span>
    <span class="kt">int</span> <span class="n">co_nlocals</span><span class="p">;</span>             <span class="cm">/* #local variables */</span>
    <span class="kt">int</span> <span class="n">co_stacksize</span><span class="p">;</span>           <span class="cm">/* #entries needed for evaluation stack */</span>
    <span class="kt">int</span> <span class="n">co_flags</span><span class="p">;</span>               <span class="cm">/* CO_..., see below */</span>
    <span class="kt">int</span> <span class="n">co_firstlineno</span><span class="p">;</span>         <span class="cm">/* first source line number */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_code</span><span class="p">;</span>          <span class="cm">/* instruction opcodes */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_consts</span><span class="p">;</span>        <span class="cm">/* list (constants used) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_names</span><span class="p">;</span>         <span class="cm">/* list of strings (names used) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_varnames</span><span class="p">;</span>      <span class="cm">/* tuple of strings (local variable names) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_freevars</span><span class="p">;</span>      <span class="cm">/* tuple of strings (free variable names) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">co_cellvars</span><span class="p">;</span>      <span class="cm">/* tuple of strings (cell variable names) */</span>
    <span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>

<p>Объект кода можно создать с помощью встроенной функции <a href="https://docs.python.org/3/library/functions.html#compile">compile</a>:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s2">&quot;x + 1&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">co</span><span class="o">.</span><span class="n">co_names</span>
<span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">co</span><span class="o">.</span><span class="n">co_code</span>
<span class="sa">b</span><span class="s1">&#39;e</span><span class="se">\x00</span><span class="s1">d</span><span class="se">\x00\x17\x00</span><span class="s1">S</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">BINARY_ADD</span>
              <span class="mi">6</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Мы уже говорили, что байткод выполняется виртуальной машиной CPython, но для его выполнения нужен контекст, например, в примере выше инструкция <code>LOAD_CONST</code> помещает значение константы на стек данных, но объект кода ничего не знает про стек. Объекты кода также не содержат информации о состояни и интерпретатора или потока, в котором они выполняются. Таким образом, для выполнения объектов кода требуется еще одна структура, которая будет предоставлять соответствующий контекст, такой структурой является фрейм (frame object, он же стек фрейм):</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="n">_frame</span> <span class="p">{</span>
    <span class="n">PyObject_VAR_HEAD</span>
    <span class="k">struct</span> <span class="n">_frame</span> <span class="o">*</span><span class="n">f_back</span><span class="p">;</span>      <span class="cm">/* previous frame, or NULL */</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">f_code</span><span class="p">;</span>       <span class="cm">/* code segment */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_builtins</span><span class="p">;</span>       <span class="cm">/* builtin symbol table (PyDictObject) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_globals</span><span class="p">;</span>        <span class="cm">/* global symbol table (PyDictObject) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_locals</span><span class="p">;</span>         <span class="cm">/* local symbol table (any mapping) */</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">f_valuestack</span><span class="p">;</span>    <span class="cm">/* points after the last local */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_trace</span><span class="p">;</span>          <span class="cm">/* Trace function */</span>
    <span class="kt">int</span> <span class="n">f_stackdepth</span><span class="p">;</span>           <span class="cm">/* Depth of value stack */</span>
    <span class="kt">char</span> <span class="n">f_trace_lines</span><span class="p">;</span>         <span class="cm">/* Emit per-line trace events? */</span>
    <span class="kt">char</span> <span class="n">f_trace_opcodes</span><span class="p">;</span>       <span class="cm">/* Emit per-opcode trace events? */</span>

    <span class="cm">/* Borrowed reference to a generator, or NULL */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_gen</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">f_lasti</span><span class="p">;</span>                <span class="cm">/* Last instruction if called */</span>
    <span class="cm">/* Call PyFrame_GetLineNumber() instead of reading this field</span>
<span class="cm">       directly.  As of 2.3 f_lineno is only valid when tracing is</span>
<span class="cm">       active (i.e. when f_trace is set).  At other times we use</span>
<span class="cm">       PyCode_Addr2Line to calculate the line from the current</span>
<span class="cm">       bytecode index. */</span>
    <span class="kt">int</span> <span class="n">f_lineno</span><span class="p">;</span>               <span class="cm">/* Current line number */</span>
    <span class="kt">int</span> <span class="n">f_iblock</span><span class="p">;</span>               <span class="cm">/* index in f_blockstack */</span>
    <span class="n">PyFrameState</span> <span class="n">f_state</span><span class="p">;</span>       <span class="cm">/* What state the frame is in */</span>
    <span class="n">PyTryBlock</span> <span class="n">f_blockstack</span><span class="p">[</span><span class="n">CO_MAXBLOCKS</span><span class="p">];</span> <span class="cm">/* for try and loop blocks */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">f_localsplus</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* locals+stack, dynamically sized */</span>
<span class="p">};</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">caller</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;f() was called by &#39;{caller}&#39;&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">h</span><span class="p">():</span>
    <span class="n">f</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="p">()</span>
<span class="n">f</span><span class="p">()</span> <span class="n">was</span> <span class="n">called</span> <span class="n">by</span> <span class="s1">&#39;h&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="p">()</span>
<span class="n">f</span><span class="p">()</span> <span class="n">was</span> <span class="n">called</span> <span class="n">by</span> <span class="s1">&#39;&lt;module&gt;&#39;</span>
</code></pre></div>

<p><img alt="" src="../../images/lectures/functions/frames.jpg" /></p>
<h2 id="_3">Атрибуты функций</h2>
<p>Как мы уже говорили, все является объектом, включая функции. Функции представлены структурой <a href="https://github.com/python/cpython/blob/3.8/Include/funcobject.h#L21">PyFunctionObject</a>:
<div class="highlight"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_code</span><span class="p">;</span>        <span class="cm">/* A code object, the __code__ attribute */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_globals</span><span class="p">;</span>     <span class="cm">/* A dictionary (other mappings won&#39;t do) */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_defaults</span><span class="p">;</span>    <span class="cm">/* NULL or a tuple */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_kwdefaults</span><span class="p">;</span>  <span class="cm">/* NULL or a dict */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_closure</span><span class="p">;</span>     <span class="cm">/* NULL or a tuple of cell objects */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_doc</span><span class="p">;</span>         <span class="cm">/* The __doc__ attribute, can be anything */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_name</span><span class="p">;</span>        <span class="cm">/* The __name__ attribute, a string object */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_dict</span><span class="p">;</span>        <span class="cm">/* The __dict__ attribute, a dict or NULL */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_weakreflist</span><span class="p">;</span> <span class="cm">/* List of weak references */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_module</span><span class="p">;</span>      <span class="cm">/* The __module__ attribute, can be anything */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_annotations</span><span class="p">;</span> <span class="cm">/* Annotations, a dict or NULL */</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func_qualname</span><span class="p">;</span>    <span class="cm">/* The qualified name */</span>
    <span class="n">vectorcallfunc</span> <span class="n">vectorcall</span><span class="p">;</span>

    <span class="cm">/* Invariant:</span>
<span class="cm">     *     func_closure contains the bindings for func_code-&gt;co_freevars, so</span>
<span class="cm">     *     PyTuple_Size(func_closure) == PyCode_GetNumFree(func_code)</span>
<span class="cm">     *     (func_closure may be NULL if PyCode_GetNumFree(func_code) == 0).</span>
<span class="cm">     */</span>
<span class="p">}</span> <span class="n">PyFunctionObject</span><span class="p">;</span>
</code></pre></div></p>
<p>Давайте разберемся с полями этой структуры.</p>
<p>Поле <code>func_code</code> (<code>__code__</code>) хранит ссылку на структуру <code>PyCodeObject</code> («объект кода»), которая в свою очередь содержит инструкции для виртуальной машины Python, число аргументов, сами аргументы и т.д. Более подробно мы остановимся на этой структуре в одной из следующих лекций.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">square</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">BINARY_POWER</span>
              <span class="mi">6</span> <span class="n">RETURN_VALUE</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_code</span>
<span class="sa">b</span><span class="s1">&#39;|</span><span class="se">\x00</span><span class="s1">d</span><span class="se">\x01\x13\x00</span><span class="s1">S</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="n">square</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_code</span><span class="p">)</span>
<span class="p">[</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<p>Список опкодов можно найти в файле <a href="https://github.com/python/cpython/blob/3.8/Include/opcode.h">Include/opcode.h</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ...</span>
<span class="cp">#define BINARY_POWER             19</span>
<span class="c1">// ...</span>
<span class="cp">#define RETURN_VALUE             83</span>
<span class="c1">// ...</span>
<span class="cp">#define LOAD_CONST              100</span>
<span class="c1">// ...</span>
<span class="cp">#define LOAD_FAST               124</span>
</code></pre></div>

<h3><code>func_globals</code></h3>
<p><a href="https://punchagan.muse-amuse.in/blog/python-globals/">https://punchagan.muse-amuse.in/blog/python-globals/</a></p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>Every function has an associated <strong>globals</strong> dictionary, which is the same as the module’s <strong>dict</strong> for the module where it was defined. This <strong>globals</strong> dict is the name-space that is looked up when trying to fetch globals within a function.</p>
</div>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; square.__globals__
{&#39;__annotations__&#39;: {},
 &#39;__builtins__&#39;: &lt;module &#39;builtins&#39; (built-in)&gt;,
 &#39;__doc__&#39;: None,
 &#39;__loader__&#39;: &lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;,
 &#39;__name__&#39;: &#39;__main__&#39;,
 &#39;__package__&#39;: None,
 &#39;__spec__&#39;: None,
 &#39;square&#39;: &lt;function square at 0x1060a50d0&gt;}
</code></pre></div>

<p>Поля <code>func_defaults</code> (<code>__defaults__</code>) и <code>func_kwdefaults</code> (<code>__kwdefaults__</code>) содержат значения по умолчанию для позиционных и ключевых аргументов, соответственно:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="o">.</span><span class="n">__kwdefaults__</span>
<span class="p">{</span><span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">inf</span><span class="p">}</span>
</code></pre></div>

<p>Важно отметить, что поля <code>__defaults__</code> и <code>__kwdefaults__</code> являются изменяемыми и инициализируются один раз при создании функции. Рассмотрим два примера: </p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">buggy_append</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">buggy_append</span><span class="o">.</span><span class="vm">__defaults__</span>
<span class="p">([],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">buggy_append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">buggy_append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">buggy_append</span><span class="o">.</span><span class="vm">__defaults__</span>
<span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">buggy_append</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">buggy_append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="p">()</span>
<span class="o">...</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">foo</span><span class="p">()</span> <span class="n">missing</span> <span class="mi">1</span> <span class="n">required</span> <span class="n">keyword</span><span class="o">-</span><span class="n">only</span> <span class="n">argument</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="n">__kwdefaults__</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="p">()</span>
<span class="mi">25</span>
</code></pre></div>

<p>Поле <code>__closure__</code> содержит кортеж значений, а именно ячеек (cell objects), необходимых функции, но находящихся в объемлющем пространстве имен. Давайте рассмотрим следующий пример:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">curry_pow</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">base</span><span class="o">**</span><span class="n">x</span>
    <span class="k">return</span> <span class="n">power</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">pow2</span> <span class="o">=</span> <span class="n">curry_pow2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pow2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">8</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Приведенный пример иллюстрирует каррирование, то есть процесс, при котором функция от нескольких аргументов преобразуется в функцию (или набор функций) от одного аргумента.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pow2</span><span class="o">.</span><span class="vm">__closure__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="n">cell</span> <span class="n">at</span> <span class="o">...</span><span class="p">:</span> <span class="nb">int</span> <span class="nb">object</span> <span class="n">at</span> <span class="o">...&gt;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pow2</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cell_contents</span>
<span class="mi">2</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">curry_pow</span><span class="p">)</span>
  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">1</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">power</span> <span class="n">at</span> <span class="mh">0x10a5e0810</span> <span class="o">...&gt;</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="s1">&#39;curry_pow.&lt;locals&gt;.power&#39;</span><span class="p">)</span>
              <span class="mi">8</span> <span class="n">MAKE_FUNCTION</span>            <span class="mi">8</span>
             <span class="mi">10</span> <span class="n">STORE_FAST</span>               <span class="mi">1</span> <span class="p">(</span><span class="n">power</span><span class="p">)</span>

  <span class="mi">4</span>          <span class="mi">12</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">power</span><span class="p">)</span>
             <span class="mi">14</span> <span class="n">RETURN_VALUE</span>

<span class="n">Disassembly</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">power</span> <span class="n">at</span> <span class="mh">0x10a5e0810</span> <span class="o">...&gt;</span><span class="p">:</span>
  <span class="mi">3</span>           <span class="mi">0</span> <span class="n">LOAD_DEREF</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">BINARY_POWER</span>
              <span class="mi">6</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Поле <code>func_doc</code> (<code>__doc__</code>), как вы уже могли догадаться, содержит строку документации:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="s1">&#39; Function to get the smallest number.</span><span class="se">\n</span><span class="s1">...&#39;</span>
</code></pre></div>

<p>Поле <code>func_name</code> (<code>__name__</code>) является изменяемым и содержит имя функции. Значение этого атрибута обычно используется такими модулями как <a href="https://docs.python.org/3/library/pydoc.html">pydoc</a> для генерирования документации:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="vm">__name__</span>
<span class="s1">&#39;square&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">help</span><span class="p">(</span><span class="n">square</span><span class="p">)</span>
<span class="n">Help</span> <span class="n">on</span> <span class="n">function</span> <span class="n">square</span><span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;cube&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">help</span><span class="p">(</span><span class="n">square</span><span class="p">)</span>
<span class="n">Help</span> <span class="n">on</span> <span class="n">function</span> <span class="n">cube</span><span class="o">...</span>
</code></pre></div>

<p>Необходимость в возможности изменения этого атрибута станет очевидной, когда мы будем говорить о декораторах, но мы всегда можем получить исходное имя функции через неизменяемый атрибут <code>co_name</code> у объекта кода:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_name</span>
<span class="s1">&#39;square&#39;</span>
</code></pre></div>

<p>Поле <code>func_dict</code> (<code>__dict__</code>) содержит ссылку на словарь с произвольными (пользовательскими) атрибутами (см. <a href="https://www.python.org/dev/peps/pep-0232/">PEP 232 - Function Attributes</a>).</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="vm">__dict__</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sqaure</span><span class="o">.</span><span class="n">ru_doc</span> <span class="o">=</span> <span class="s1">&#39;Функция возведения значния аргумента в квадрат&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">square</span><span class="o">.</span><span class="vm">__dict__</span>
<span class="p">{</span><span class="s1">&#39;ru_doc&#39;</span><span class="p">:</span> <span class="s1">&#39;Функция возведения значния аргумента в квадрат&#39;</span><span class="p">}</span>
</code></pre></div>

<p><mark>Поле <code>func_weakreflist</code> содержит список, так назыаемых, слабых ссылок, о которых мы будем говорить в одной из следующих лекций.</mark></p>
<p>Поле <code>func_module</code> (<code>__module__</code>) это имя модуля, в котором была определена функция:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span>
<span class="s1">&#39;__main__&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sqaure</span><span class="o">.</span><span class="vm">__module__</span>
<span class="s1">&#39;__main__&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;__secondary__&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cube</span><span class="o">.</span><span class="vm">__module__</span>
<span class="s1">&#39;__secondary__&#39;</span>
</code></pre></div>

<p>Поле <code>func_annotations</code> (<code>__annotations__</code>) содержит аннотации и зачастую используется статистическими анализаторами кода, такими как <a href="http://mypy-lang.org/">mypy</a> или <a href="https://pyre-check.org/">pyre</a>:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">my_min</span><span class="o">.</span><span class="n">__annotations__</span>
<span class="p">{</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">float</span><span class="s1">&#39;&gt;,</span>
    <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">float</span><span class="s1">&#39;&gt;,</span>
    <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">float</span><span class="s1">&#39;&gt;,</span>
    <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">float</span><span class="s1">&#39;&gt;,</span>
    <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">float</span><span class="s1">&#39;&gt;</span>
<span class="p">}</span>
</code></pre></div>

<p>Поле <code>func_qualname</code> (<code>__qualname__</code>) содержит «расширенное» имя функции или класса и используется для <a href="https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%82%D1%80%D0%BE%D1%81%D0%BF%D0%B5%D0%BA%D1%86%D0%B8%D1%8F_%D0%B2_Python">интроспекции</a> (см. <a href="https://www.python.org/dev/peps/pep-3155/">PEP 3155</a>):</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">B</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">A</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="vm">__name__</span>
<span class="s1">&#39;d&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">A</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">__qualname__</span>
<span class="s1">&#39;A.B.d&#39;</span>
</code></pre></div>

<h2 id="_4">Вызов функций</h2>
<p>Концепция callable-объекта является фундаментальной в Python. Когда мы думаем о том, что может быть «вызвано» (called), то первое, что приходит на ум, это функции. Но кроме функций есть еще методы и классы, а также любой объект, в типе которого определен магический метод <code>__call__</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Joke</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;That what she said&#39;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">joke</span> <span class="o">=</span> <span class="n">Joke</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">joke</span><span class="p">()</span>
<span class="s1">&#39;That what she said&#39;</span>
</code></pre></div>

<p>В этом примере мы «вызываем» класс <code>Joke</code> для инстанцирования нового объекта, а затем осуществляем «вызов» экземпляра класса как если бы это была обычная функция (о классах мы будем говорить в лекции <a href="../classes/">«ООП. Классы»</a>). </p>
<p><mark>Можно сказать, что наличие <code>(arg1, arg2,...)</code> указывает на то, что происходит «вызов» и, в большинстве случаев, генерируется опкод <code>CALL_FUNCTION</code> (вызов callable-объекта с позиционными аргументами):</mark></p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">dis</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;add(1,2)&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">add</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">2</span>
              <span class="mi">8</span> <span class="n">RETURN_VALUE</span>
</code></pre></div>

<p>Вот описание опкода из документации:</p>
<div class="admonition quote">
<p class="admonition-title"><code>CALL_FUNCTION(argc)</code></p>
<p>Calls a callable object with positional arguments. <code>argc</code> indicates the number of positional arguments. The top of the stack contains positional arguments, with the right-most argument on top. Below the arguments is a callable object to call. <code>CALL_FUNCTION</code> pops all arguments and the callable object off the stack, calls the callable object with those arguments, and pushes the return value returned by the callable object.</p>
</div>
<p>Давайте кратко рассмотрим обработчик опкода <a href="https://github.com/python/cpython/blob/3.8/Python/ceval.c#L3496">CALL_FUNCTION</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">case</span> <span class="nf">TARGET</span><span class="p">(</span><span class="n">CALL_FUNCTION</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">PREDICTED</span><span class="p">(</span><span class="n">CALL_FUNCTION</span><span class="p">);</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">stack_pointer</span><span class="p">;</span>
<span class="hll">    <span class="n">res</span> <span class="o">=</span> <span class="n">call_function</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">,</span> <span class="n">oparg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span>    <span class="n">stack_pointer</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
    <span class="n">PUSH</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">DISPATCH</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>Фактически происходит вызов функции <a href="https://github.com/python/cpython/blob/3.8/Python/ceval.c#L3496">call_function</a>, куда передается адрес вершины стека <code>sp</code> и число позиционных аргументов <code>oparg</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">sp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">sp</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">sp</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
<span class="err">$</span><span class="mi">3</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">at</span> <span class="n">remote</span> <span class="mh">0x1014597d0</span><span class="o">&gt;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="p">((</span><span class="n">PyFunctionObject</span><span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">sp</span><span class="o">-</span><span class="mi">3</span><span class="p">)))</span><span class="o">-&gt;</span><span class="n">func_name</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">add</span><span class="err">&#39;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">oparg</span>
<span class="err">$</span><span class="mi">5</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="https://www.ics.uci.edu/~pattis/common/handouts/macmingweclipse/allexperimental/mac-gdb-install.html">https://www.ics.uci.edu/~pattis/common/handouts/macmingweclipse/allexperimental/mac-gdb-install.html</a> </p>
</div>
<p><code>call_function</code> является общей для вызова функций, методов, классов и других объектов:</p>
<div class="highlight"><pre><span></span><code><span class="n">Py_LOCAL_INLINE</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span> <span class="n">_Py_HOT_FUNCTION</span>
<span class="n">call_function</span><span class="p">(</span><span class="n">PyThreadState</span> <span class="o">*</span><span class="n">tstate</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">***</span><span class="n">pp_stack</span><span class="p">,</span> <span class="n">Py_ssize_t</span> <span class="n">oparg</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">pfunc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span> <span class="o">-</span> <span class="n">oparg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="o">*</span><span class="n">pfunc</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">nkwargs</span> <span class="o">=</span> <span class="p">(</span><span class="n">kwnames</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">PyTuple_GET_SIZE</span><span class="p">(</span><span class="n">kwnames</span><span class="p">);</span>
    <span class="n">Py_ssize_t</span> <span class="n">nargs</span> <span class="o">=</span> <span class="n">oparg</span> <span class="o">-</span> <span class="n">nkwargs</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pp_stack</span><span class="p">)</span> <span class="o">-</span> <span class="n">nargs</span> <span class="o">-</span> <span class="n">nkwargs</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tstate</span><span class="o">-&gt;</span><span class="n">use_tracing</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">trace_call_function</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">nargs</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
<span class="hll">        <span class="n">x</span> <span class="o">=</span> <span class="n">_PyObject_Vectorcall</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">nargs</span> <span class="o">|</span> <span class="n">PY_VECTORCALL_ARGUMENTS_OFFSET</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">);</span>
</span>    <span class="p">}</span>

    <span class="c1">// ...</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Происходит подготовка аргументов для вызова функции <a href="https://github.com/python/cpython/blob/3.8/Include/cpython/abstract.h#L114"><code>_PyObject_Vectorcall</code></a>, где <code>nargs</code> и <code>nkwargs</code> указывает на число позиционных и именованных аргументов, соответственно, <code>nkwargs</code> представляет собой кортеж с именами ключевых аргументов (см. опкод <code>CALL_FUNCTION_KW</code>), <code>stack</code> указывает на первый аргумент функции, а <code>func</code> указывает на объект <code>PyFunctionObject</code> (нашу функцию <code>add</code>):</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">nargs</span>
<span class="err">$</span><span class="mi">6</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">nkwargs</span>
<span class="err">$</span><span class="mi">7</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">kwnames</span>
<span class="err">$</span><span class="mi">8</span> <span class="o">=</span> <span class="mh">0x0</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="n">stack</span>
<span class="err">$</span><span class="mi">9</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">stack</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="err">$</span><span class="mi">10</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">stack</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="err">$</span><span class="mi">11</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">at</span> <span class="n">remote</span> <span class="mh">0x1014597d0</span><span class="o">&gt;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">func</span>
<span class="err">$</span><span class="mi">12</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">at</span> <span class="n">remote</span> <span class="mh">0x1014597d0</span><span class="o">&gt;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">p</span> <span class="p">((</span><span class="n">PyFunctionObject</span><span class="o">*</span><span class="p">)</span><span class="mh">0x1014597d0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">func_name</span>
<span class="err">$</span><span class="mi">13</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">add</span><span class="err">&#39;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kr">inline</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">_PyObject_Vectorcall</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">callable</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                     <span class="kt">size_t</span> <span class="n">nargsf</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
    <span class="n">vectorcallfunc</span> <span class="n">func</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="hll">    <span class="n">func</span> <span class="o">=</span> <span class="n">_PyVectorcall_Function</span><span class="p">(</span><span class="n">callable</span><span class="p">);</span>
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_ssize_t</span> <span class="n">nargs</span> <span class="o">=</span> <span class="n">PyVectorcall_NARGS</span><span class="p">(</span><span class="n">nargsf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_PyObject_MakeTpCall</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">nargs</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">);</span>
    <span class="p">}</span>
<span class="hll">    <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">nargsf</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">);</span>
</span>    <span class="k">return</span> <span class="n">_Py_CheckFunctionResult</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>В функции <code>_PyObject_Vectorcall</code> проверяется поддерживает ли callable-объект новый протокол Vectorcall, который был введен в <a href="https://www.python.org/dev/peps/pep-0590/">PEP 590</a> с целью оптимизации вызова callable-объектов:</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>The poor performance is largely a result of having to create intermediate tuples, and possibly intermediate dicts, during the call. This is mitigated in CPython by including special-case code to speed up calls to Python and builtin functions. Unfortunately, this means that other callables such as classes and third party extension objects are called using the slower, more general <code>tp_call</code> calling convention.</p>
<p>This PEP proposes that the calling convention used internally for Python and builtin functions is generalized and published so that all calls can benefit from better performance...</p>
</div>
<p>Отметим, что все пользовательские функции, начиная с Python 3.8, поддерживают протокол Vectorcall. Возможно, вы обратили внимание, что последнем полем структуры <code>PyFunctionObject</code> является <code>vectorcall</code> типа <a href="https://github.com/python/cpython/blob/3.8/Include/cpython/object.h#L58"><code>vectorcallfunc</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span> <span class="n">PyObject</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">vectorcallfunc</span><span class="p">)(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">callable</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                    <span class="kt">size_t</span> <span class="n">nargsf</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">);</span>
</code></pre></div>

<p>Это поле инициализируется при <a href="https://github.com/python/cpython/blob/3.8/Objects/funcobject.c#L12">создании</a> новой функции (см. опкод <code>MAKE_FUNCTION</code>):</p>
<div class="highlight"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">PyFunction_NewWithQualName</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">code</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">globals</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">qualname</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyFunctionObject</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
    <span class="c1">// ...</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">PyObject_GC_New</span><span class="p">(</span><span class="n">PyFunctionObject</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PyFunction_Type</span><span class="p">);</span>
    <span class="c1">// ...</span>
<span class="hll">    <span class="n">op</span><span class="o">-&gt;</span><span class="n">vectorcall</span> <span class="o">=</span> <span class="n">_PyFunction_Vectorcall</span><span class="p">;</span>
</span>    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Таким образом, вызов:
<div class="highlight"><pre><span></span><code><span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">nargsf</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">);</span>
</code></pre></div></p>
<p>эквивалентен вызову:</p>
<div class="highlight"><pre><span></span><code><span class="n">res</span> <span class="o">=</span> <span class="n">_PyFunction_Vectorcall</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">nargsf</span><span class="p">,</span> <span class="n">kwnames</span><span class="p">);</span>
</code></pre></div>

<p>Наконец перейдем к <a href="https://github.com/python/cpython/blob/3.8/Objects/call.c#L386"><code>_PyFunction_Vectorcall</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">_PyFunction_Vectorcall</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="k">const</span><span class="o">*</span> <span class="n">stack</span><span class="p">,</span>
                       <span class="kt">size_t</span> <span class="n">nargsf</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwnames</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyCodeObject</span> <span class="o">*</span><span class="n">co</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyCodeObject</span> <span class="o">*</span><span class="p">)</span><span class="n">PyFunction_GET_CODE</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

    <span class="c1">// ...</span>

    <span class="k">return</span> <span class="n">_PyEval_EvalCodeWithName</span><span class="p">((</span><span class="n">PyObject</span><span class="o">*</span><span class="p">)</span><span class="n">co</span><span class="p">,</span> <span class="n">globals</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
                                    <span class="n">stack</span><span class="p">,</span> <span class="n">nargs</span><span class="p">,</span>
                                    <span class="n">nkwargs</span> <span class="o">?</span> <span class="n">_PyTuple_ITEMS</span><span class="p">(</span><span class="n">kwnames</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
                                    <span class="n">stack</span> <span class="o">+</span> <span class="n">nargs</span><span class="p">,</span>
                                    <span class="n">nkwargs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">nd</span><span class="p">,</span> <span class="n">kwdefs</span><span class="p">,</span>
                                    <span class="n">closure</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">qualname</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Отметим лишь два момента, первый, это получение объекта кода, о котором мы говорили ранее, и второе, создание и исполнение (evaluation) нового фрейма (о фреймах мы будем говорить в одной из следующих лекций) с телом нашей функции. </p>
<h2 id="_5">Декораторы</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A decorator is any callable Python object that is used to modify a function, method or class definition. A decorator is passed the original object being defined and returns a modified object, which is then bound to the name in the definition.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">logtime</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;timelog.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{time.time()}</span><span class="se">\t</span><span class="s2">{func.__name}</span><span class="se">\t</span><span class="s2">{total_time}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">accepts</span><span class="p">(</span><span class="o">*</span><span class="n">types</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_accepts</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_argcount</span>
        <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> \
                       <span class="s2">&quot;arg </span><span class="si">%r</span><span class="s2"> does not match </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="n">new_f</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">func_name</span>
        <span class="k">return</span> <span class="n">new_f</span>
    <span class="k">return</span> <span class="n">check_accepts</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">rtype</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_returns</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">rtype</span><span class="p">),</span> \
                   <span class="s2">&quot;return value </span><span class="si">%r</span><span class="s2"> does not match </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">rtype</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="n">new_f</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">func_name</span>
        <span class="k">return</span> <span class="n">new_f</span>
    <span class="k">return</span> <span class="n">check_returns</span>
</code></pre></div>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Последнее обновление: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">25 октября 2020 г.</span>
    
  </small>
</div>
                  
                
              
              
                


  <h2 id="__comments">Комментарии</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="https://dementiy.github.io/lectures/functions/",this.page.identifier="lectures/functions/"};!function(){var e=document,i=e.createElement("script");i.src="//Dementiy.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)}()</script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../control-statements/" title="Управляющие конструкции" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Назад
                </span>
                Управляющие конструкции
              </div>
            </div>
          </a>
        
        
          <a href="../ns_and_scopes/" title="Пространство имен и области видимости" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Вперед
                </span>
                Пространство имен и области видимости
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 - 2020 <a href="https://github.com/Dementiy" target="_blank" rel="noopener">Dmitrii Sorokin</a>

          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/Dementiy" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432 \u0431\u0443\u0444\u0435\u0440", "clipboard.copied": "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440", "search.config.lang": "ru", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "\u041d\u0430\u0447\u043d\u0438\u0442\u0435 \u043f\u0435\u0447\u0430\u0442\u0430\u0442\u044c \u0434\u043b\u044f \u043f\u043e\u0438\u0441\u043a\u0430", "search.result.none": "\u0421\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e", "search.result.one": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e 1 \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0435", "search.result.other": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e # \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["tabs", "instant"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>