



<!doctype html>
<html lang="ru" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Лекции и практические задания по программированию на Python">
      
      
        <link rel="canonical" href="https://dementiy.github.io/lectures/ns_and_scopes/">
      
      
        <meta name="author" content="Sorokin Dmitrii">
      
      
        <meta name="lang:clipboard.copy" content="Копировать в буфер">
      
        <meta name="lang:clipboard.copied" content="Скопировано в буфер">
      
        <meta name="lang:search.language" content="en, ru">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="Совпадений не найдено">
      
        <meta name="lang:search.result.one" content="Найдено 1 совпадение">
      
        <meta name="lang:search.result.other" content="Найдено # совпадений">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Простарнство имен и области видимости - Программирование на Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://dementiy.github.io/" title="Программирование на Python" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Программирование на Python
            </span>
            <span class="md-header-nav__topic">
              
                Простарнство имен и области видимости
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Начните печатать для поиска
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Dementiy/pybook-assignments/" title="Перейти к репозиторию" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../immutable-types/" title="Лекции" class="md-tabs__link md-tabs__link--active">
          Лекции
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../assignments/setup_env/" title="Практические работы" class="md-tabs__link">
          Практические работы
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://dementiy.github.io/" title="Программирование на Python" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Программирование на Python
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Dementiy/pybook-assignments/" title="Перейти к репозиторию" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" checked>
    
    <label class="md-nav__link" for="nav-1">
      Лекции
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Лекции
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../immutable-types/" title="Неизменяемые типы данных" class="md-nav__link">
      Неизменяемые типы данных
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mutable-types/" title="Изменяемые типы данных" class="md-nav__link">
      Изменяемые типы данных
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../control-statements/" title="Управляющие конструкции" class="md-nav__link">
      Управляющие конструкции
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../functions/" title="Функции" class="md-nav__link">
      Функции
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
    <a href="./" title="Простарнство имен и области видимости" class="md-nav__link md-nav__link--active">
      Простарнство имен и области видимости
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Жизненный цикл программы" class="md-nav__link">
      Жизненный цикл программы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../classes/" title="ООП. Классы. Магические методы" class="md-nav__link">
      ООП. Классы. Магические методы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../descriptors/" title="ООП. Дескрипторы" class="md-nav__link">
      ООП. Дескрипторы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../attribute_lookup/" title="ООП. Разрешение имен атрибтутов" class="md-nav__link">
      ООП. Разрешение имен атрибтутов
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="ООП. Наследование. Абстрактные классы" class="md-nav__link">
      ООП. Наследование. Абстрактные классы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mro/" title="ООП. Порядок разрешения методов" class="md-nav__link">
      ООП. Порядок разрешения методов
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="ООП. Метаклассы" class="md-nav__link">
      ООП. Метаклассы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Модули и пакеты" class="md-nav__link">
      Модули и пакеты
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../iterators/" title="Итераторы" class="md-nav__link">
      Итераторы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Генераторы" class="md-nav__link">
      Генераторы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Конкурентность и параллелизм. Потоки" class="md-nav__link">
      Конкурентность и параллелизм. Потоки
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Конкурентность и параллелизм. Примитивы синхронизации" class="md-nav__link">
      Конкурентность и параллелизм. Примитивы синхронизации
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Конкурентность и параллелизм. Процессы" class="md-nav__link">
      Конкурентность и параллелизм. Процессы
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Конкурентность и параллелизм. Корутины" class="md-nav__link">
      Конкурентность и параллелизм. Корутины
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Управление памятью. Счетчик ссылок" class="md-nav__link">
      Управление памятью. Счетчик ссылок
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Управление памятью. Сборщик мусора" class="md-nav__link">
      Управление памятью. Сборщик мусора
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Практические работы
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Практические работы
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Basics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Basics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/setup_env/" title="Настройка рабочего окружения" class="md-nav__link">
      Настройка рабочего окружения
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/cypher/" title="Алгоритмы шифрования" class="md-nav__link">
      Алгоритмы шифрования
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/sudoku/" title="Решатель Судоку" class="md-nav__link">
      Решатель Судоку
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="С-расширения" class="md-nav__link">
      С-расширения
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Игра «Жизнь»" class="md-nav__link">
      Игра «Жизнь»
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Работа с API ВКонтакте" class="md-nav__link">
      Работа с API ВКонтакте
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Бот для мессенджера Telegram" class="md-nav__link">
      Бот для мессенджера Telegram
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/hackernews/" title="Персонализация новостной ленты Hacker News" class="md-nav__link">
      Персонализация новостной ленты Hacker News
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Приложение для ведения заметок" class="md-nav__link">
      Приложение для ведения заметок
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Простой асинхронный сервер" class="md-nav__link">
      Простой асинхронный сервер
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Простой асинхронный веб-фреймворк" class="md-nav__link">
      Простой асинхронный веб-фреймворк
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Чат на базе веб-сокетов" class="md-nav__link">
      Чат на базе веб-сокетов
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      DataScience
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        DataScience
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignments/descriptive-statistics/" title="Описательная статистика с Pandas, SQL и R" class="md-nav__link">
      Описательная статистика с Pandas, SQL и R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Линейная регрессия" class="md-nav__link">
      Линейная регрессия
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Логистическая регрессия" class="md-nav__link">
      Логистическая регрессия
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Деревья. Случайные леса" class="md-nav__link">
      Деревья. Случайные леса
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Кластеризация методом k-средних" class="md-nav__link">
      Кластеризация методом k-средних
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="Рекомендательная система кинофильмов и аниме" class="md-nav__link">
      Рекомендательная система кинофильмов и аниме
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="MicroTorch: библиотека для обучения нейронных сетей" class="md-nav__link">
      MicroTorch: библиотека для обучения нейронных сетей
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Dementiy/pybook-assignments/edit/master/docs/lectures/ns_and_scopes.md" title="Редактировать страницу" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Простарнство имен и области видимости</h1>
                
                <p>Настало время поговорить об областях видимости и пространстве имен. Но прежде вспомним, что в Python переменных в том смысле, в каком они есть в таких языках программирования как C/C++/Java/и т.д., нет, но есть символьные имена, которые связаны с объектами (у которых уже есть тип, точнее ссылка на соответствующую структуру). Таким образом, запись вида <code class="codehilite"><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span></code> означает связывание имени (name binding) <code class="codehilite"><span class="n">a</span></code> с объектом <code class="codehilite"><span class="mi">1</span></code> (<code class="codehilite"><span class="n">PyLongObject</span></code>).</p>
<p>Рассмотрим следующий простой пример:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">some_variable</span>
<span class="c1"># ...</span>
<span class="ne">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s1">&#39;some_variable&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</pre></div>

<p>Мы получили ошибку <code class="codehilite"><span class="n">NameError</span></code>, но откуда интерпретатор знает, что такого имени не существует? Чтобы ответить на этот вопрос мы должны познакомиться с еще двумя <a href="https://softwareengineering.stackexchange.com/questions/273302/what-is-the-relationship-between-scope-and-namespaces-in-python">понятиями</a>: пространство имен и области видимости:</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>A namespace is a dictionary, mapping names (as strings) to values. When you do an assignment, like <code class="codehilite"><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span></code>, you’re mutating a namespace. When you make a reference, like <code class="codehilite"><span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></code>, Python looks through a list of namespaces to try and find one with the name as a key.</p>
<p>A scope defines which namespaces will be looked in and in what order. The scope of any reference always starts in the local namespace, and moves outwards until it reaches the module’s global namespace, before moving on to the builtins (the namespace that references Python’s predefined functions and constants, like range and getattr), which is the end of the line.</p>
</div>
<p>Итак, о пространстве имен можно думать как словаре, в котором ключами являются имена «переменных», а значениям связанные с именами объекты. В свою очередь область видимости опеределяет какие пространства имен мы должны просмотреть в поиске указанного имени. Перебор областей видимости происходит в следующем порядке: локальная (L - Local) область видимости, объемлющая (E - Enclosed), глоабльная (G - Global) и встроенная (B - Built-in).</p>
<p>Вернемся к примеру с нашей переменной some_variable:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="s2">&quot;some_variable&quot;</span><span class="p">)</span>
  <span class="mi">1</span>           <span class="mi">0</span> <span class="n">LOAD_NAME</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">some_variable</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">RETURN_VALUE</span>
</pre></div>

<p>Опкод <a href="https://github.com/python/cpython/blob/master/Python/ceval.c"><code class="codehilite"><span class="n">LOAD_NAME</span></code></a> отвечает за помещение значения <code class="codehilite"><span class="n">some_variable</span></code> на стек и при выполнении этой инструкции происходит обход областей видимости в указанном выше пордяке, и, если имя не было найдено, то будет порождено исключение <code class="codehilite"><span class="n">NameError</span></code>. Упрощенно этот процесс можно представить следующим <a href="https://tech.blog.aknin.name/2010/06/05/pythons-innards-naming/">образом</a>:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">LOAD_NAME</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">current_stack_frame</span><span class="o">.</span><span class="n">locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">current_stack_frame</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">current_stack_frame</span><span class="o">.</span><span class="n">builtins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;name {name} is not defined&quot;</span><span class="p">)</span>
    <span class="n">PUSH</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">STORE_NAME</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">POP</span><span class="p">()</span>
    <span class="n">current_stack_frame</span><span class="o">.</span><span class="n">locals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>

<p>Кроме пары опкодов <code class="codehilite"><span class="n">LOAD_NAME</span><span class="o">/</span><span class="n">STORE_NAME</span></code> есть и другие опкоды <code class="codehilite"><span class="n">LOAD_</span><span class="o">*/</span><span class="n">STORE_</span><span class="o">*</span></code>, которые взаимодействуют с областью видимости. Давайте рассмотрим следующий пример очень простой функции:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">local_var</span> <span class="o">=</span> <span class="s1">&#39;local variable&#39;</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">local_var</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="s1">&#39;local variable&#39;</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">local_var</span><span class="p">)</span>

  <span class="mi">3</span>           <span class="mi">4</span> <span class="n">LOAD_GLOBAL</span>              <span class="mi">0</span> <span class="p">(</span><span class="k">print</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">local_var</span><span class="p">)</span>
              <span class="mi">8</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">1</span>
             <span class="mi">10</span> <span class="n">POP_TOP</span>
             <span class="mi">12</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
             <span class="mi">14</span> <span class="n">RETURN_VALUE</span>
</pre></div>

<p>Опкод <code class="codehilite"><span class="n">LOAD_CONST</span></code> отношения к области видимости не имеет, потому что константы не являются переменными. Тем не менее, мы можем задаться вопросом «Где эти константы искать?». Для этого нам придется ввести еще одно понятие - <a href="https://docs.python.org/3/reference/executionmodel.html">code object</a>:</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>A Python program is constructed from code blocks. A block is a piece of Python program text that is executed as a unit. The following are blocks: a module, a function body, and a class definition. Each command typed interactively is a block. A script file (a file given as standard input to the interpreter or specified as a command line argument to the interpreter) is a code block. A script command (a command specified on the interpreter command line with the '-c' option) is a code block. The string argument passed to the built-in functions eval() and exec() is a code block.</p>
<p>A code block is executed in an execution frame. A frame contains some administrative information (used for debugging) and determines where and how execution continues after the code block’s execution has completed.</p>
</div>
<p>Code object в первую очередь содержит исполняемый байт-код, а также набор атрибутов среди которых: число аргументов, список констант, список имен локальных перменных и т.д.</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_consts</span>
<span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;local variable&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span>
<span class="p">(</span><span class="s1">&#39;local_var&#39;</span><span class="p">,)</span>
</pre></div>

<p>Продолжая рассматривать пример мы обнаружим, что используется еще пара опкодов <code class="codehilite"><span class="n">LOAD_FAST</span><span class="o">/</span><span class="n">STORE_FAST</span></code>, которые используются в том случае, когда компилятор может вывести, что некоторые имена используются исключительно в локальной области видимости. Следует заметить, что в таком случае для хранения значений локальных переменных используется массив фиксированного размера (вместо словарей), что приводит к более быстрому поиску значения для соответствующего имени.</p>
<p>Теперь рассмотрим пример с использованием глобальных имен:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">global_var</span> <span class="o">=</span> <span class="s1">&#39;global variable&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">global_var</span><span class="p">)</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_GLOBAL</span>              <span class="mi">0</span> <span class="p">(</span><span class="k">print</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">LOAD_GLOBAL</span>              <span class="mi">1</span> <span class="p">(</span><span class="n">global_var</span><span class="p">)</span>
              <span class="mi">4</span> <span class="n">CALL_FUNCTION</span>            <span class="mi">1</span>
              <span class="mi">6</span> <span class="n">POP_TOP</span>
              <span class="mi">8</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="bp">None</span><span class="p">)</span>
             <span class="mi">10</span> <span class="n">RETURN_VALUE</span>
</pre></div>

<p>Инструкции <code class="codehilite"><span class="o">*</span><span class="n">_GLOBAL</span></code> генерируются в том случае, когда компилятор может вывести, что некоторое имя используется внутри функции, но никогда не связывается с каким-либо объектом, как в нашем примере с переменной <code class="codehilite"><span class="n">global_var</span></code> и функцией <code class="codehilite"><span class="n">print</span></code>. Таким образом, <code class="codehilite"><span class="n">LOAD_GLOBAL</span></code> позволяет избежать поиска имени в локальном пространстве имен, а осуществляет поиск только в глобальном (<code class="codehilite"><span class="n">global_var</span></code>) и встроенном (<code class="codehilite"><span class="n">print</span></code>) пространствах имен (если имя не было найдено, то будет порождено исключение <code class="codehilite"><span class="n">NameError</span></code>).</p>
<p>Последняя пара опкодов, о которых мы поговорим, это <code class="codehilite"><span class="n">LOAD_DEREF</span></code> и <code class="codehilite"><span class="n">STORE_DEREF</span></code>. Python позволяет нам создавать вложенные функции. Давайте рассмотрим следующий простой пример:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">some_variable</span> <span class="o">=</span> <span class="s1">&#39;some_variable&#39;</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">h</span><span class="p">():</span>
<span class="o">...</span>         <span class="k">return</span> <span class="n">some_variable</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">h</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span><span class="p">()</span>
<span class="n">some_variable</span>
</pre></div>

<p>Может возникнуть вполне закономерный вопрос: «Как функция <code class="codehilite"><span class="n">h</span></code> может использовать значение перменной <code class="codehilite"><span class="n">some_variable</span></code>, если пространства имен, в которой эта переменная была создана, уже не существует?». Давайте посмотрим на список инструкций:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="mi">2</span>           <span class="mi">0</span> <span class="n">LOAD_CONST</span>               <span class="mi">1</span> <span class="p">(</span><span class="s1">&#39;some_variable&#39;</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">STORE_DEREF</span>              <span class="mi">0</span> <span class="p">(</span><span class="n">some_variable</span><span class="p">)</span>

  <span class="mi">3</span>           <span class="mi">4</span> <span class="n">LOAD_CLOSURE</span>             <span class="mi">0</span> <span class="p">(</span><span class="n">some_variable</span><span class="p">)</span>
              <span class="mi">6</span> <span class="n">BUILD_TUPLE</span>              <span class="mi">1</span>
              <span class="mi">8</span> <span class="n">LOAD_CONST</span>               <span class="mi">2</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">h</span> <span class="n">at</span> <span class="mh">0x10bd47d20</span> <span class="o">...&gt;</span><span class="p">)</span>
             <span class="mi">10</span> <span class="n">LOAD_CONST</span>               <span class="mi">3</span> <span class="p">(</span><span class="s1">&#39;f.&lt;locals&gt;.h&#39;</span><span class="p">)</span>
             <span class="mi">12</span> <span class="n">MAKE_FUNCTION</span>            <span class="mi">8</span>
             <span class="mi">14</span> <span class="n">STORE_FAST</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span>

  <span class="mi">5</span>          <span class="mi">16</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span>
             <span class="mi">18</span> <span class="n">RETURN_VALUE</span>

<span class="n">Disassembly</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">h</span> <span class="n">at</span> <span class="mh">0x10bd47d20</span> <span class="o">...&gt;</span><span class="p">:</span>
  <span class="mi">4</span>           <span class="mi">0</span> <span class="n">LOAD_DEREF</span>               <span class="mi">0</span> <span class="p">(</span><span class="n">some_variable</span><span class="p">)</span>
              <span class="mi">2</span> <span class="n">RETURN_VALUE</span>
</pre></div>

<p>Заметим, что переменная <code class="codehilite"><span class="n">some_variable</span></code> по отношению к функции <code class="codehilite"><span class="n">f</span></code> хоть и является локальной, но обрабатывается с помощью опкодов <code class="codehilite"><span class="n">LOAD_DEREF</span><span class="o">/</span><span class="n">STORE_DEREF</span></code>, а не <code class="codehilite"><span class="n">LOAD_FAST</span><span class="o">/</span><span class="n">STORE_FAST</span></code> как мы могли бы ожидать. Если на этапе компиляции становится ясно, что переменная используется во вложенных областях видимости, то для работы с ней не будут использованы обычные опкоды, вместо этого будет создан специальный объект <a href="https://docs.python.org/3/c-api/cell.html#cell-objects"><code class="codehilite"><span class="n">cell</span></code></a>, который является контейнером для ссылки на другой объект (в нашем примере <code class="codehilite"><span class="n">some_variable</span></code>) и не зависит от сущестования стека объемлющей функции.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Для создания или изменения глобальных переменных в локальной области видимости используется ключевое слово <a href="https://docs.python.org/3/reference/simple_stmts.html#global"><code class="codehilite"><span class="k">global</span></code></a>; аналогично для объемлющей облатси видимости существует ключевое слово <a href="https://www.python.org/dev/peps/pep-3104/"><code class="codehilite"><span class="n">nonlocal</span></code></a>.</p>
</div>
<p>Если в функции присутствуют переменные, которые были определены в объемлющей области видимости, то такую функцию называют замыканием (closure):</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">g</span><span class="o">.</span><span class="vm">__closure__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="n">cell</span> <span class="n">at</span> <span class="mh">0x10c329f48</span><span class="p">:</span> <span class="nb">str</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10c34e470</span><span class="o">&gt;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cell_contents</span>
<span class="s1">&#39;some_variable&#39;</span>
</pre></div>
                
                  
                
              
              
                


  <h2 id="__comments">Комментарии</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://dementiy.github.io/lectures/ns_and_scopes/";
      this.page.identifier =
        "lectures/ns_and_scopes/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//Dementiy.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../functions/" title="Функции" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Назад
                </span>
                Функции
              </span>
            </div>
          </a>
        
        
          <a href="../classes/" title="ООП. Классы. Магические методы" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Вперед
                </span>
                ООП. Классы. Магические методы
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/Dementiy" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.245445c6.js"></script>
      
        
        
          
          <script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
          
            
              
              
                <script src="../../assets/javascripts/lunr/lunr.ru.js"></script>
              
            
          
          
            <script src="../../assets/javascripts/lunr/lunr.multi.js"></script>
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>